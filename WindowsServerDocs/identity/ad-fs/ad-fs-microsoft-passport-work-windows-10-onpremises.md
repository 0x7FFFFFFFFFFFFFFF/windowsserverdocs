---
title: AD FS and Microsoft Passport for Work in Windows 10 on-premises
ms.custom: na
ms.prod: windows-server-threshold
ms.reviewer: na
ms.service: ad-health-connect
ms.suite: na
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: fa754fda-0379-4104-bf80-dc4a6602c080
---
# AD FS and Microsoft Passport for Work in Windows 10 on-premises


One of the benefits of Windows 10 devices that are registered with AD FS is the convenience and security that comes with Windows Hello and Microsoft Passport for Work. 

Microsoft Passport for Work is supported on domain joined devices registered with AD FS to authenticate to work apps. For more details on the problems of passwords please see Problems with traditional credentials section in the [Microsoft Passport guide](https://technet.microsoft.com/itpro/windows/keep-secure/microsoft-passport-guide).

This document will describe registering devices and using Microsoft Passport for Work on-premises only.  For information on Azure AD and Microsoft Passport see [Azure AD and Microsoft Passport for Work.](https://jairocadena.com/2016/03/09/azure-ad-and-microsoft-passport-for-work-in-windows-10/)
  
## How device registration works on-premises
The following steps describe how device registration with AD FS works.

![ADFS_ITPRO_1media/ADFS_Passport_1.png)

1. Policy tells device to start registering with AD FS. 

By enabling the policy **Register domain computers as devices** and having it deployed via group policy, the registration process with Azure AD will begin. 

This policy is located at:  Computer Configuration/Policies/Administrative Templates/Windows Components/Device Registration

![ADFS_ITPRO_1media/ADFS_ITPRO_3.png)

2. The device will query Active Directory to get information about Active Directory and AD FS

Information about Active Directory is stored in a Service Connection Point (SCP). This SCP is created when you enable device authentication.

3. The device authenticates itself to AD via AD FS to get a token for registration

Once it gets this information, the device authenticates to AD FS Device Registration Service via AD FS. 

Windows 10 computers will authenticate using Windows Integrated authentication to an active WSTrust endpoint hosted by AD FS.  You must ensure this endpoint is enabled.  If you are using the Web Authentication Proxy, you must also ensure this endpoint is published through the proxy. 


1. Open Server Manager and navigate to Tools > AD FS Management. 
2. Navigate to AD FS > Service > Endpoints 
3. Right click on /adfs/services/trust/13/windowstransport and select Enable. 

![ADFS_ITPRO_1media/ADFS_ITPRO_6.png)

AD FS issues a token to AD before AD issues the final token for AD FS DRS. Three claims are passed to AD via the AD FS token when the computer authenticates, and are written as attributes in the newly created device object:

* Object GUID of computer object on-prem.
<code>c1:[Type == "http://schemas.microsoft.com/ws/2012/01/accounttype", Value == "DJ", Issuer =~ "^(AD AUTHORITY|SELF AUTHORITY|LOCAL AUTHORITY)$"] && c2:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer =~ "^(AD AUTHORITY|SELF AUTHORITY|LOCAL AUTHORITY)$"] => issue(store = "Active Directory", types = ("http://schemas.microsoft.com/identity/claims/onpremobjectguid"), query = ";objectguid;{0}", param = c2.Value); </code>
* SID (Security Identifier) of computer object on-prem.
<code>c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/primarygroupsid", Value =~ "515$", Issuer =~ "^(AD AUTHORITY|SELF AUTHORITY|LOCAL AUTHORITY)$"] => issue(Type = "http://schemas.microsoft.com/ws/2012/01/accounttype", Value = "DJ"); </code>
* Claim stating that computer is domain joined.
<code>c1:[Type == "http://schemas.microsoft.com/ws/2012/01/accounttype", Value == "DJ", Issuer =~ "^(AD AUTHORITY|SELF AUTHORITY|LOCAL AUTHORITY)$"] && c2:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid", Issuer =~ "^(AD AUTHORITY|SELF AUTHORITY|LOCAL AUTHORITY)$"] => issue(claim = c2); 
</code>

The claims are generated by three AD FS issuance transform rules that are created by Azure AD Connect during Express installation.  Azure AD Connect will then later use these attributes in the device object to correlate it with the computer object in on-premises AD. This is needed for lifecycle of the device object which is authoritative on-premises.

4. Device generates keys used in device registration

The task generates a private/public key pair to be used in a certificate signing request (CSR) to AD FS DRS to obtain the certificate that the device will use to authenticate to Azure AD later on.

Additionally, the task generates a second private/public key pair that is later used to bind the Primary Refresh Token (PRT) to the physical device upon authentication. This removes the risk of token replay in other devices.  The device will also obtain an AD FS PRT for SSO to AD FS applications.

5. Device registers with AD via AD FS DRS

The task sends the CSR obtaining the certificate which it places in the LocalMachine\My store. A device object is created in Azure AD and the certificate thumbprint is associated with it.

In addition the public key for PRT binding is registered with the device object as well.

Once this is complete the new benefits outlined above will be available.  For additional information see [Connect domain-joined devices to Azure AD for Windows 10 experiences.](https://azure.microsoft.com/en-us/documentation/articles/active-directory-azureadjoin-devices-group-policy/)

## The Microsoft Passport for Work experience

A device needs to be Azure AD joined, domain joined (which has auto-registered with Azure AD) or configured with Add Work or School Account before holding a Microsoft Passport for Work credential.  After an Azure AD joined or domain joined device has completed registration, on the next user sign-in to Windows the Microsoft Passport for Work provisioning experience will show up.

The experience is launched after the user signs in to Windows if the following conditions are true:
  * Microsoft Passport for Work policy signals provisioning.  The device is domain joined and policy is enabled.
  * The current session is not a remote session.

Once the conditions listed above are met the user will see the provisioning experience. 

![ADFS_Passport_2media/ADFS_Passport_2.png)

Once the user clicks on the ‘Create PIN’ button registration begins and performs two operations:
* authenticates the current user to get a token (step 3 above)
* generates the key pair (RSA 2048 bit key pairs) and registers the public key with AD FS DRS using the token (step 4 above)

After the key pair is obtained, the PIN collection UI shows up and the user is asked for a PIN. A logical container is created and the private key is placed in it:

![ADFS_Passport_2media/ADFS_Passport_3.png)

A container is a logical grouping of key material protected by a protector key which is associated with a gesture. In this case the PIN is associated with a protector key that is obtained at this time. This key securely wraps the Microsoft Passport for Work private key recently obtained. The PIN gesture is the one that can “open” the container and allow access to the key.

The registration now will take the AD FS DRS access token and the key information and post it to AD FS DRS to the following end-point:

POST http://adfs.contoso.com/EnrollmentServer/

AD FS DRS will find the user object in the directory and add the key information to a particular multi-valued attribute. The key information will contain a reference to the device ID (both user and device IDs are obtained from the token). A user object will have one key for every device where the user has provisioned a Microsoft Passport for Work credential.

Finally after the credential has been provisioned it can be used to authenticate to AD on-premises upon sign-in to Windows. 

With regard to authenticating on-premises remember the following:

* the device needs to be able to reach a DC running Windows Server 2016 (TP 5 or greater)
* there is no need to have a new Domain or Forest Functional Level in the on-premises AD.
* As an alternative to deploying new DCs, logon certificates using the Microsoft Passport for Work key can be deployed.
* To support logon certificates using the Microsoft Passport for Work key, it is required to have System Center Configuration Manager Technical Preview (domain joined devices) or Intune (Azure AD joined devices) (additional 3rd party MDMs may have this support as well).

## Pre\-requisites for this scenario
The following are a list of pre\-requisites that are required prior to completing this document. This document assumes that AD FS has been installed and an AD FS farm has been created.

-   Intune subscription \(for MDM integration and device compliance scenarios\)


-   Windows Server 2016 TP5  or newer for AD FS

-   Windows Server 2016 domain controller
    with Windows Server 2016 schema.

-   Windows 10 client build 10586 or newer, joined to the above domain.


## Setup Active Directory and AD FS
To setup Active Directory and AD FS use the following procedure:

#### To setup AD and AD FS

1.  Create a new AD FS farm using Windows Server 2016 Preview
* Ensure the domain is running  Windows Server 2016 Preview
* Ensure the Active Directory schema version is at least 85
* Create the AD FS farm
* Setup  a new AD FS farm using Windows Server 2016 Preview
* Mixed farm migration of an AD FS farm using Windows Server 2012 R2 to 2016

> [!NOTE]
        > You will need to set\-adfsproperties –enableidpinitiatedsignonpage $true to enable the sign on page.   This is disabled by default.



2.  Prepare AD

* On your AD FS primary server, ensure you are logged in as AD DS user with Enterprise Admin \(EA\) privileges and open an elevated powershell prompt
* The below commands require Active Directory administration tools, so if your AD FS server is not also a domain controller, first install the tools using the following steps:
* Run the Add Roles & Features wizard and select feature Remote Server Administration tools \-> Role Administration Tools \-> AD DS and AD LDS Tools \-> Choose both the Active Directory module for Windows PowerShell and the AD DS Tools.
* From the same elevated PowerShell command prompt, run Import\-module activedirectory
* Execute the following AD FS PowerShell commands:

        ```
        PS C:\>Initialize-ADDeviceRegistration –ServiceAccountName “<AD FS service account name>”
        ```
> [!NOTE]
        > If your AD FS service is configured to use a GMSA account, enter the account name in the format “domain\\accountname$”

        ```
        PS C:\>Enable-AdfsDeviceRegistration

        PS C:\>Set-AdfsGlobalAuthenticationPolicy –DeviceAuthenticationEnabled $true
        ```


* The above commands achieve the following in AD DS:

*   Create a new object of type serviceConnectionpoint at CN\=&lt;guid&gt;, CN\=Device Registration Configuration,CN\=Services,CN\=Configuration,DC\=&lt;domain&gt;   
* Allow read\/write access to the specified AD connector account name on the new object

 ## Configure Group Policy for device registration
Configure Automatic Device Registration via Group Policy in Active Directory: You can use an Active Directory Group Policy to configure your Windows 10 domain joined devices to automatically register with Azure AD. To do this please see the following step\-by\-step instructions:

#### To configure group policy for device registration

1.  Open Server Manager and navigate to **Tools** > **Group Policy Management.**

2.  From **Group Policy Management**, navigate to the domain node that corresponds to the domain in which you would like to enable Automatic Workplace Join.

3.  Right\-click **Group Policy Objects** and select New. Give your Group Policy object a name, for example, Automatic Device Registration. Click OK.

4.  Right\-click on your new Group Policy object and then select **Edit.**

5.  Navigate to **Computer Configuration > Policies > Administrative Templates > Windows Components > Workplace Join.**

    > [!NOTE]
    > The Group Policy template has been renamed in Windows 10.
    > 
    > If you are running the Group Policy tool from a Windows 10 computer, the policy will appear as: 
    > **Register domain joined computers as devices**
    > 
    > The policy will be located under the following location:
    > **Computer Configuration\/Policies\/Administrative Templates\/Windows Components\/Device  Registration**.

6.  Right\-click Automatically workplace join client computers and then select Edit.

7.  Select the Enabled radio button and then click Apply. Click OK.

8.  You may now link the Group Policy object to a location of your choice. For example:

    -   A specific Organizational Unit \(OU\) in AD where Windows 10 domain\-joined computers will be located.

    -   A specific security group containing Windows 10 domain\-joined computers that will be auto\-registered with Azure AD.
    
 ## Configure Microsoft Passport
For information on configuring Microsoft Passport see  [Enable Microsoft Passport for work in the organization](https://azure.microsoft.com/en-us/documentation/articles/active-directory-azureadjoin-passport-deployment/) and the [Microsoft Passport guide](https://technet.microsoft.com/itpro/windows/keep-secure/microsoft-passport-guide).  


